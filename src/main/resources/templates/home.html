<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" href="/style.css">
    <title>Home | Calendar</title>

</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Calendar</div>
            <div class="user-info">
                <div class="avatar" th:text="${#strings.substring(username, 0, 1)}"></div>
                <div class="user-email" th:text="${email}"></div>
                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="logout-btn">Logout</button>
                </form>
            </div>
        </header>
        
        <h1 class="welcome-message">
            Welcome, <span th:text="${username}"></span>!
        </h1>
        
        <div class="calendar-container">
            <div class="calendar-header">
                <h2 class="calendar-title" id="current-month">Май 2025</h2>
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" onclick="previousMonth()">Назад</button>
                    <button class="calendar-nav-btn" onclick="nextMonth()">Вперёд</button>
                </div>
            </div>
            
            <div class="calendar-grid">
                <div class="calendar-day-header">Пн</div>
                <div class="calendar-day-header">Вт</div>
                <div class="calendar-day-header">Ср</div>
                <div class="calendar-day-header">Чт</div>
                <div class="calendar-day-header">Пт</div>
                <div class="calendar-day-header weekend">Сб</div>
                <div class="calendar-day-header weekend">Вс</div>
                
                <div id="calendar-days" class="calendar-grid" style="grid-column: 1 / -1;"></div>
            </div>
        </div>
    </div>

    <!-- Modal for adding events -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Добавить событие</h3>
                <span class="close">&times;</span>
            </div>
            <form id="eventForm">
                <input type="hidden" id="eventDate" name="date">
                <div class="form-group">
                    <label for="eventTitle">Название</label>
                    <input type="text" id="eventTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label for="eventDescription">Описание</label>
                    <textarea id="eventDescription" name="description"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

<script>
    let currentDate = new Date();
    let selectedDay = null;

    const monthNames = [
        "Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
        "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
    ];

    const monthNamesGenitive = [
        "Января", "Февраля", "Марта", "Апреля", "Мая", "Июня",
        "Июля", "Августа", "Сентября", "Октября", "Ноября", "Декабря"
    ];

    function renderCalendar() {
        document.getElementById('current-month').textContent =
            `${monthNamesGenitive[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();

        let startingDay = firstDay.getDay();
        if (startingDay === 0) startingDay = 7;
        startingDay -= 1;

        const prevMonthLastDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();

        const today = new Date();
        const isCurrentMonth = currentDate.getMonth() === today.getMonth() &&
            currentDate.getFullYear() === today.getFullYear();

        let calendarHtml = '';

        for (let i = 0; i < startingDay; i++) {
            const day = prevMonthLastDay - startingDay + i + 1;
            calendarHtml += `<div class="calendar-day other-month">
                <div class="calendar-day-number">${day}</div>
            </div>`;
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const isToday = isCurrentMonth && i === today.getDate();
            const dayOfWeek = new Date(currentDate.getFullYear(), currentDate.getMonth(), i).getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

            const formattedDate = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;

            calendarHtml += `<div class="calendar-day ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''}" data-date="${formattedDate}">
                <div class="calendar-day-number">${i}</div>
                <div class="events-container"></div>
                <button class="add-event-btn" onclick="openEventModal(${i})">+</button>
            </div>`;
        }

        const totalCells = startingDay + daysInMonth;
        const remainingCells = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;

        for (let i = 1; i <= remainingCells; i++) {
            calendarHtml += `<div class="calendar-day other-month">
                <div class="calendar-day-number">${i}</div>
            </div>`;
        }

        document.getElementById('calendar-days').innerHTML = calendarHtml;
    }

    function renderCalendarAndEvents() {
        renderCalendar();
        loadAllEvents();
    }

    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendarAndEvents();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendarAndEvents();
    }

    function openEventModal(day) {
        selectedDay = day;
        const formattedDate = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        document.getElementById('eventDate').value = formattedDate;

        const modalTitle = `Добавить событие на ${day} ${monthNamesGenitive[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        document.querySelector('.modal-title').textContent = modalTitle;

        document.getElementById('eventModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('eventModal').style.display = 'none';
        document.getElementById('eventForm').reset();
    }

    document.querySelector('.close').addEventListener('click', closeModal);

    window.addEventListener('click', function(event) {
        if (event.target === document.getElementById('eventModal')) {
            closeModal();
        }
    });

    document.getElementById('eventForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const eventData = {
            title: formData.get('title'),
            description: formData.get('description'),
            date: formData.get('date')
        };

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch('/events', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify(eventData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при добавлении события');
            }
            return response.json();
        })
        .then(data => {
            console.log('Событие добавлено:', data);
            closeModal();
            renderCalendarAndEvents();
        })
        .catch((error) => {
            console.error('Ошибка:', error);
        });
    });

    function loadAllEvents() {
        const dayElements = document.querySelectorAll('.calendar-day[data-date]');

        dayElements.forEach(dayEl => {
            const date = dayEl.getAttribute('data-date');
            const eventsContainer = dayEl.querySelector('.events-container');
            if (!eventsContainer) return;

            eventsContainer.innerHTML = '';

            fetch(`/events/by-date/${date}`)
                .then(response => response.json())
                .then(events => {
                    events.forEach(event => {
                        const eventElement = document.createElement('div');
                        eventElement.className = 'calendar-event';
                        eventElement.textContent = event.title;
                        eventsContainer.appendChild(eventElement);
                    });
                })
                .catch(error => {
                    console.error(`Ошибка при загрузке событий для ${date}:`, error);
                });
        });
    }

    renderCalendarAndEvents();
</script>

</body>
</html>